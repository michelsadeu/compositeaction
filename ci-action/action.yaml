name: 'Parse /ci Comment'
description: 'Parse and extract parameters from /ci comments'
author: 'Michel-SG'

inputs:
  github-token:
    description: 'GitHub token for API access'
    required: false
    default: ${{ github.token }}

outputs:
  target:
    description: 'Target parameter'
    value: ${{ steps.parse-ci.outputs.TARGET }}
  version:
    description: 'Version parameter'
    value: ${{ steps.parse-ci.outputs.VERSION }}
  coverage:
    description: 'Coverage parameter'
    value: ${{ steps.parse-ci.outputs.COVERAGE }}
  parameters:
    description: 'All parameters as JSON'
    value: ${{ steps.parse-ci.outputs.parameters }}
  workflow_call_triggered:
    description: 'Whether workflow_call was triggered successfully'
    value: ${{ steps.trigger-workflow-call.outputs.workflow_call_triggered }}
  workflow_dispatch_triggered:
    description: 'Whether workflow_dispatch was triggered successfully'
    value: ${{ steps.trigger-workflow-dispatch.outputs.workflow_dispatch_triggered }}

runs:
  using: "composite"
  steps:
    - name: Parse /ci comment
      id: parse-ci
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          try {
            const commentBody = context.payload.comment?.body || '';
            
            core.info(`üìù Commentaire re√ßu: ${commentBody}`);
            
            // V√©rifier si le commentaire commence par /ci
            if (!commentBody.startsWith('/ci')) {
              throw new Error('Le commentaire ne commence pas par /ci');
            }
            
            core.info('‚úÖ Commande /ci d√©tect√©e');
            
            // Extraire la partie apr√®s "/ci "
            const paramsString = commentBody.substring(4).trim();
            
            if (!paramsString) {
              throw new Error('Aucun param√®tre trouv√© apr√®s /ci');
            }
            
            core.info(`üì¶ Param√®tres bruts: ${paramsString}`);
            
            // Parser les param√®tres
            const paramArray = paramsString
              .split(';')
              .map(p => p.trim())
              .filter(p => p);
            
            const params = {};
            let paramCount = 0;
            
            for (const param of paramArray) {
              const colonIndex = param.indexOf(':');
              
              if (colonIndex === -1) {
                core.warning(`‚ö†Ô∏è Format invalide pour le param√®tre: ${param}`);
                continue;
              }
              
              const cleanKey = param.substring(0, colonIndex).trim().toLowerCase();
              const cleanValue = param.substring(colonIndex + 1).trim();
              
              if (!cleanKey || !cleanValue) {
                core.warning(`‚ö†Ô∏è Param√®tre incomplet: cl√©="${cleanKey}", valeur="${cleanValue}"`);
                continue;
              }
              
              core.info(`‚úì Param√®tre trouv√©: ${cleanKey} = ${cleanValue}`);
              
              params[cleanKey] = cleanValue;
              core.setOutput(cleanKey.toUpperCase(), cleanValue);
              paramCount++;
            }
            
            if (paramCount === 0) {
              throw new Error('Aucun param√®tre valide trouv√©');
            }
            
            core.info(`‚úÖ ${paramCount} param√®tre(s) extrait(s) avec succ√®s`);
            core.info(`üìä R√©sum√©: ${JSON.stringify(params)}`);
            
            // Exporter tous les param√®tres en JSON
            core.setOutput('parameters', JSON.stringify(params));
            
          } catch (error) {
            core.setFailed(`‚ùå Erreur: ${error.message}`);
          }
    
    - name: Trigger jenkinstest workflow_call
      id: trigger-workflow-call
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          try {
            core.info('üì§ D√©clenchement du workflow_call sur michelsadeu/jenkinstest');
            
            const dispatchResponse = await github.rest.actions.createWorkflowDispatch({
              owner: 'michelsadeu',
              repo: 'jenkinstest',
              workflow_id: 'workflow_call.yml',
              ref: 'main',
              inputs: {
                pr_number: '${{ github.event.issue.number }}',
                message: 'CI workflow completed successfully - triggered by /ci comment'
              }
            });
            
            core.info('‚úÖ workflow_call d√©clench√© avec succ√®s');
            core.setOutput('workflow_call_triggered', 'true');
            
          } catch (error) {
            core.warning(`‚ö†Ô∏è Erreur lors du d√©clenchement du workflow_call: ${error.message}`);
            core.setOutput('workflow_call_triggered', 'false');
          }
    
    - name: Trigger jenkinstest workflow_dispatch
      id: trigger-workflow-dispatch
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          try {
            core.info('üì§ D√©clenchement du workflow_dispatch sur michelsadeu/jenkinstest');
            
            const dispatchResponse = await github.rest.actions.createWorkflowDispatch({
              owner: 'michelsadeu',
              repo: 'jenkinstest',
              workflow_id: 'workflow_dispatch.yml',
              ref: 'main',
              inputs: {
                pr_number: '${{ github.event.issue.number }}',
                message: 'CI workflow completed successfully - triggered by /ci comment'
              }
            });
            
            core.info('‚úÖ workflow_dispatch d√©clench√© avec succ√®s');
            core.setOutput('workflow_dispatch_triggered', 'true');
            
          } catch (error) {
            core.warning(`‚ö†Ô∏è Erreur lors du d√©clenchement du workflow_dispatch: ${error.message}`);
            core.setOutput('workflow_dispatch_triggered', 'false');
          }
